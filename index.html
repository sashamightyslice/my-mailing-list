#!/usr/bin/env python3
"""
Simple Mailing List Backend
A basic script to manage subscribers and send emails
"""

import json
import smtplib
import csv
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from datetime import datetime
import os

class SimpleMailingList:
    def __init__(self, data_file='subscribers.json'):
        self.data_file = data_file
        self.subscribers = self.load_subscribers()
    
    def load_subscribers(self):
        """Load subscribers from JSON file"""
        try:
            with open(self.data_file, 'r') as f:
                return json.load(f)
        except FileNotFoundError:
            return []
    
    def save_subscribers(self):
        """Save subscribers to JSON file"""
        with open(self.data_file, 'w') as f:
            json.dump(self.subscribers, f, indent=2)
    
    def add_subscriber(self, name, email):
        """Add a new subscriber"""
        # Check if email already exists
        for sub in self.subscribers:
            if sub['email'].lower() == email.lower():
                return False, "Email already subscribed"
        
        subscriber = {
            'id': len(self.subscribers) + 1,
            'name': name,
            'email': email,
            'date_added': datetime.now().isoformat(),
            'active': True
        }
        
        self.subscribers.append(subscriber)
        self.save_subscribers()
        return True, "Subscriber added successfully"
    
    def remove_subscriber(self, email):
        """Remove a subscriber"""
        self.subscribers = [sub for sub in self.subscribers if sub['email'].lower() != email.lower()]
        self.save_subscribers()
    
    def get_active_subscribers(self):
        """Get list of active subscribers"""
        return [sub for sub in self.subscribers if sub.get('active', True)]
    
    def export_to_csv(self, filename='subscribers.csv'):
        """Export subscribers to CSV"""
        with open(filename, 'w', newline='') as csvfile:
            fieldnames = ['name', 'email', 'date_added']
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
            writer.writeheader()
            for sub in self.subscribers:
                writer.writerow({
                    'name': sub['name'],
                    'email': sub['email'],
                    'date_added': sub['date_added']
                })
    
    def send_email(self, subject, message, smtp_server, smtp_port, username, password, from_email):
        """Send email to all active subscribers"""
        active_subs = self.get_active_subscribers()
        
        if not active_subs:
            print("No active subscribers found.")
            return
        
        try:
            # Connect to SMTP server
            server = smtplib.SMTP(smtp_server, smtp_port)
            server.starttls()
            server.login(username, password)
            
            successful_sends = 0
            failed_sends = 0
            
            for subscriber in active_subs:
                try:
                    # Create message
                    msg = MIMEMultipart()
                    msg['From'] = from_email
                    msg['To'] = subscriber['email']
                    msg['Subject'] = subject
                    
                    # Personalize message
                    personalized_message = message.replace('{name}', subscriber['name'])
                    
                    # Add unsubscribe link (you'd need to implement this)
                    personalized_message += f"\n\n---\nTo unsubscribe, reply with 'UNSUBSCRIBE' in the subject line."
                    
                    msg.attach(MIMEText(personalized_message, 'plain'))
                    
                    # Send email
                    text = msg.as_string()
                    server.sendmail(from_email, subscriber['email'], text)
                    successful_sends += 1
                    print(f"✓ Sent to {subscriber['name']} ({subscriber['email']})")
                    
                except Exception as e:
                    print(f"✗ Failed to send to {subscriber['email']}: {str(e)}")
                    failed_sends += 1
            
            server.quit()
            print(f"\nEmail sending complete!")
            print(f"Successful: {successful_sends}, Failed: {failed_sends}")
            
        except Exception as e:
            print(f"SMTP connection error: {str(e)}")

def main():
    """Main function to demonstrate usage"""
    ml = SimpleMailingList()
    
    print("Simple Mailing List Manager")
    print("=" * 30)
    
    while True:
        print("\nOptions:")
        print("1. Add subscriber")
        print("2. List subscribers")
        print("3. Send email")
        print("4. Export to CSV")
        print("5. Remove subscriber")
        print("6. Exit")
        
        choice = input("\nEnter your choice (1-6): ").strip()
        
        if choice == '1':
            name = input("Enter name: ").strip()
            email = input("Enter email: ").strip()
            success, message = ml.add_subscriber(name, email)
            print(f"{'✓' if success else '✗'} {message}")
        
        elif choice == '2':
            active_subs = ml.get_active_subscribers()
            print(f"\nActive Subscribers ({len(active_subs)}):")
            for i, sub in enumerate(active_subs, 1):
                print(f"{i}. {sub['name']} - {sub['email']}")
        
        elif choice == '3':
            if not ml.get_active_subscribers():
                print("No subscribers to send to!")
                continue
                
            subject = input("Enter email subject: ").strip()
            print("Enter your message (use {name} for personalization):")
            print("(Press Ctrl+D or Ctrl+Z when done)")
            
            message_lines = []
            try:
                while True:
                    line = input()
                    message_lines.append(line)
            except EOFError:
                pass
            
            message = '\n'.join(message_lines)
            
            print("\nEmail configuration:")
            smtp_server = input("SMTP server (e.g., smtp.gmail.com): ").strip()
            smtp_port = int(input("SMTP port (587 for TLS): ").strip() or "587")
            username = input("Email username: ").strip()
            password = input("Email password: ").strip()
            from_email = input("From email address: ").strip()
            
            ml.send_email(subject, message, smtp_server, smtp_port, username, password, from_email)
        
        elif choice == '4':
            filename = input("CSV filename (default: subscribers.csv): ").strip() or "subscribers.csv"
            ml.export_to_csv(filename)
            print(f"✓ Exported to {filename}")
        
        elif choice == '5':
            email = input("Enter email to remove: ").strip()
            ml.remove_subscriber(email)
            print("✓ Subscriber removed")
        
        elif choice == '6':
            print("Goodbye!")
            break
        
        else:
            print("Invalid choice. Please try again.")

if __name__ == "__main__":
    main()
